{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Abdul%20Mateen/OneDrive/Desktop/v0-instagram-video/app/api/download/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from \"next/server\"\n\n// Rate limiting map (in production, use Redis)\nconst rateLimitMap = new Map<string, { count: number; lastReset: number }>()\nconst RATE_LIMIT = 10 // requests per minute\nconst RATE_LIMIT_WINDOW = 60 * 1000 // 1 minute\n\nfunction checkRateLimit(ip: string): boolean {\n  const now = Date.now()\n  const record = rateLimitMap.get(ip)\n\n  if (!record || now - record.lastReset > RATE_LIMIT_WINDOW) {\n    rateLimitMap.set(ip, { count: 1, lastReset: now })\n    return true\n  }\n\n  if (record.count >= RATE_LIMIT) {\n    return false\n  }\n\n  record.count++\n  return true\n}\n\nfunction extractShortcode(url: string): string | null {\n  const patterns = [\n    /instagram\\.com\\/p\\/([\\w-]+)/,\n    /instagram\\.com\\/reel\\/([\\w-]+)/,\n    /instagram\\.com\\/reels\\/([\\w-]+)/,\n    /instagram\\.com\\/tv\\/([\\w-]+)/,\n  ]\n\n  for (const pattern of patterns) {\n    const match = url.match(pattern)\n    if (match) return match[1]\n  }\n  return null\n}\n\n// ============================================\n// FACEBOOK DOWNLOADER - NEW FUNCTIONALITY\n// ============================================\n\nfunction isFacebookURL(url: string): boolean {\n  const fbPatterns = [\n    /facebook\\.com\\/reel\\//,\n    /facebook\\.com\\/.*\\/videos\\//,\n    /fb\\.watch\\//,\n    /facebook\\.com\\/watch\\//,\n  ]\n  return fbPatterns.some(pattern => pattern.test(url))\n}\n\nasync function fetchFacebookVideo(url: string) {\n  console.log(\"[FB] Starting Facebook video fetch for:\", url)\n  \n  // Try multiple methods for Facebook video download\n  const methods = [\n    () => fetchViaFacebookAPI(url),\n    () => fetchViaCobalAPI(url),\n    () => fetchViaFacebookDirect(url),\n    () => fetchViaSnapSave(url)\n  ]\n\n  for (const method of methods) {\n    try {\n      const result = await method()\n      if (result && result.video_url) {\n        console.log(\"[FB] Successfully fetched video!\")\n        return result\n      }\n    } catch (e) {\n      console.log(\"[FB] Method failed, trying next:\", e)\n      continue\n    }\n  }\n\n  throw new Error(\"Unable to fetch Facebook video. The post may be private or unavailable.\")\n}\n\n// New method using a simple API approach\nasync function fetchViaFacebookAPI(url: string) {\n  try {\n    console.log(\"[FB] Trying Facebook API method for:\", url)\n    \n    // Use a simple downloader API\n    const apiUrl = `https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(url)}`\n    \n    const response = await fetch(apiUrl, {\n      headers: {\n        \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n        \"Accept\": \"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\",\n      },\n      redirect: \"follow\"\n    })\n\n    if (!response.ok) {\n      console.log(\"[FB] API response not ok:\", response.status)\n      return null\n    }\n\n    const html = await response.text()\n    \n    // PRIORITY: Extract HD quality first, then fallback to SD\n    // Look for HD quality URLs first\n    const hdPatterns = [\n      /\"playable_url_quality_hd\":\"([^\"]+)\"/,\n      /\"browser_native_hd_url\":\"([^\"]+)\"/,\n      /\"hd_src\":\"([^\"]+)\"/,\n      /hd_src:\"([^\"]+)\"/,\n      /\"playable_url\":\"([^\"]+)\"/\n    ]\n\n    // Try HD patterns first\n    for (const pattern of hdPatterns) {\n      const match = html.match(pattern)\n      if (match) {\n        const videoUrl = match[1]\n          .replace(/\\\\u0025/g, \"%\")\n          .replace(/\\\\u0026/g, \"&\")\n          .replace(/\\\\u002F/g, \"/\")\n          .replace(/\\\\/g, \"\")\n        \n        console.log(\"[FB] API method found HD video:\", videoUrl.substring(0, 100))\n        \n        return {\n          video_url: videoUrl,\n          thumbnail: undefined,\n          quality: \"HD\"\n        }\n      }\n    }\n\n    // Fallback to SD if HD not found\n    const sdPatterns = [\n      /\"browser_native_sd_url\":\"([^\"]+)\"/,\n      /\"sd_src\":\"([^\"]+)\"/,\n      /sd_src:\"([^\"]+)\"/,\n      /\"video_url\":\"([^\"]+)\"/\n    ]\n\n    for (const pattern of sdPatterns) {\n      const match = html.match(pattern)\n      if (match) {\n        const videoUrl = match[1]\n          .replace(/\\\\u0025/g, \"%\")\n          .replace(/\\\\u0026/g, \"&\")\n          .replace(/\\\\u002F/g, \"/\")\n          .replace(/\\\\/g, \"\")\n        \n        console.log(\"[FB] API method found SD video (HD not available):\", videoUrl.substring(0, 100))\n        \n        return {\n          video_url: videoUrl,\n          thumbnail: undefined,\n          quality: \"SD\"\n        }\n      }\n    }\n\n    console.log(\"[FB] API method: No video URL found\")\n\n  } catch (e) {\n    console.log(\"[FB] Facebook API method failed:\", e)\n  }\n  return null\n}\n\nasync function fetchViaCobalAPI(url: string) {\n  try {\n    console.log(\"[FB] Trying Cobalt API for:\", url)\n    \n    const response = await fetch(\"https://api.cobalt.tools/api/json\", {\n      method: \"POST\",\n      headers: {\n        \"Accept\": \"application/json\",\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        url: url,\n        vCodec: \"h264\",\n        vQuality: \"max\",  // Request maximum quality\n        aFormat: \"best\",   // Best audio format\n        filenamePattern: \"basic\",\n        isAudioOnly: false,\n        disableMetadata: false\n      })\n    })\n\n    if (!response.ok) {\n      console.log(\"[FB] Cobalt API response not ok:\", response.status)\n      return null\n    }\n\n    const data = await response.json()\n    console.log(\"[FB] Cobalt API response:\", JSON.stringify(data).substring(0, 200))\n\n    // Cobalt API returns different response structures\n    if (data.status === \"redirect\" || data.status === \"stream\" || data.status === \"tunnel\") {\n      return {\n        video_url: data.url,\n        thumbnail: data.thumb || undefined,\n        quality: \"HD\",  // Cobalt returns max quality when requested\n        duration: undefined\n      }\n    }\n\n    if (data.url) {\n      return {\n        video_url: data.url,\n        thumbnail: data.thumb || undefined,\n        quality: \"HD\"\n      }\n    }\n\n  } catch (e) {\n    console.log(\"[FB] Cobalt API failed:\", e)\n  }\n  return null\n}\n\nasync function fetchViaSnapSave(url: string) {\n  try {\n    console.log(\"[FB] Trying SnapSave for:\", url)\n    \n    // Try using fdown.net API which is more reliable\n    const apiUrl = \"https://www.getfvid.com/downloader\"\n    \n    const formData = new URLSearchParams()\n    formData.append('url', url)\n    \n    const response = await fetch(apiUrl, {\n      method: \"POST\",\n      headers: {\n        \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n        \"Content-Type\": \"application/x-www-form-urlencoded\",\n        \"Accept\": \"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\",\n        \"Origin\": \"https://www.getfvid.com\",\n        \"Referer\": \"https://www.getfvid.com/\"\n      },\n      body: formData\n    })\n\n    if (!response.ok) {\n      console.log(\"[FB] SnapSave response not ok:\", response.status)\n      return null\n    }\n\n    const html = await response.text()\n    \n    // PRIORITY: Look for HD quality links first\n    const hdPatterns = [\n      /href=\"([^\"]+)\"\\s+download=\"[^\"]*hd[^\"]*\\.mp4\"/i,\n      /href=\"([^\"]+)\"\\s+[^>]*>.*?HD.*?<\\/a>/i,\n      /<a[^>]+href=\"([^\"]+)\"[^>]*class=\"[^\"]*hd[^\"]*\"/i\n    ]\n\n    // Try HD patterns first\n    for (const pattern of hdPatterns) {\n      const match = html.match(pattern)\n      if (match) {\n        const videoUrl = match[1].replace(/&amp;/g, \"&\").replace(/\\\\u002F/g, \"/\")\n        \n        const thumbnailMatch = html.match(/poster=\"([^\"]+)\"/i) ||\n                              html.match(/\"thumbnail\":\"([^\"]+)\"/i) ||\n                              html.match(/data-thumb=\"([^\"]+)\"/i)\n        \n        console.log(\"[FB] SnapSave found HD video:\", videoUrl.substring(0, 100))\n        \n        return {\n          video_url: videoUrl,\n          thumbnail: thumbnailMatch ? thumbnailMatch[1] : undefined,\n          quality: \"HD\"\n        }\n      }\n    }\n\n    // Fallback to any quality\n    const fallbackPatterns = [\n      /href=\"([^\"]+)\"\\s+download=\"[^\"]*\\.mp4\"/i,\n      /<a[^>]+href=\"([^\"]+)\"[^>]*class=\"[^\"]*download[^\"]*\"/i,\n      /href=\"(https:\\/\\/[^\"]+\\.mp4[^\"]*)\"/i,\n      /\"downloadUrl\":\"([^\"]+)\"/i\n    ]\n\n    for (const pattern of fallbackPatterns) {\n      const match = html.match(pattern)\n      if (match) {\n        const videoUrl = match[1].replace(/&amp;/g, \"&\").replace(/\\\\u002F/g, \"/\")\n        \n        const thumbnailMatch = html.match(/poster=\"([^\"]+)\"/i) ||\n                              html.match(/\"thumbnail\":\"([^\"]+)\"/i) ||\n                              html.match(/data-thumb=\"([^\"]+)\"/i)\n        \n        console.log(\"[FB] SnapSave found video (HD not available):\", videoUrl.substring(0, 100))\n        \n        return {\n          video_url: videoUrl,\n          thumbnail: thumbnailMatch ? thumbnailMatch[1] : undefined,\n          quality: \"SD\"\n        }\n      }\n    }\n\n    console.log(\"[FB] SnapSave: No video URL found in response\")\n\n  } catch (e) {\n    console.log(\"[FB] SnapSave failed:\", e)\n  }\n  return null\n}\n\nasync function fetchViaFacebookDirect(url: string) {\n  try {\n    console.log(\"[FB] Trying direct Facebook fetch for:\", url)\n    \n    // Method 1: Try mbasic.facebook.com (mobile version)\n    const mobileUrl = url.replace('www.facebook.com', 'mbasic.facebook.com').replace('m.facebook.com', 'mbasic.facebook.com')\n    \n    const response = await fetch(mobileUrl, {\n      headers: {\n        \"User-Agent\": \"Mozilla/5.0 (Linux; Android 10; SM-G973F) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Mobile Safari/537.36\",\n        \"Accept\": \"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\",\n        \"Accept-Language\": \"en-US,en;q=0.9\",\n      },\n      redirect: \"follow\"\n    })\n\n    if (!response.ok) {\n      console.log(\"[FB] Direct fetch response not ok:\", response.status)\n      return null\n    }\n\n    const html = await response.text()\n\n    // PRIORITY: Look for HD quality URLs first\n    const hdPatterns = [\n      /\"playable_url_quality_hd\":\"([^\"]+)\"/,\n      /\"browser_native_hd_url\":\"([^\"]+)\"/,\n      /hd_src:\"([^\"]+)\"/,\n      /\"hd_src\":\"([^\"]+)\"/\n    ]\n\n    // Try HD patterns first\n    for (const pattern of hdPatterns) {\n      const match = html.match(pattern)\n      if (match) {\n        let videoUrl = match[1]\n          .replace(/\\\\u0025/g, \"%\")\n          .replace(/\\\\u0026/g, \"&\")\n          .replace(/\\\\u002F/g, \"/\")\n          .replace(/\\\\/g, \"\")\n          .replace(/&amp;/g, \"&\")\n        \n        console.log(\"[FB] Direct fetch found HD video:\", videoUrl.substring(0, 100))\n        \n        const thumbnailMatch = html.match(/\"preferred_thumbnail\":{\"image\":{\"uri\":\"([^\"]+)\"/) ||\n                              html.match(/\"thumbnailImage\":{\"uri\":\"([^\"]+)\"/) ||\n                              html.match(/og:image\"[^>]*content=\"([^\"]+)\"/)\n        \n        const thumbnail = thumbnailMatch ? thumbnailMatch[1].replace(/\\\\/g, \"\").replace(/&amp;/g, \"&\") : undefined\n\n        return {\n          video_url: videoUrl,\n          thumbnail: thumbnail,\n          quality: \"HD\"\n        }\n      }\n    }\n\n    // Fallback to other quality patterns\n    const fallbackPatterns = [\n      /\"playable_url\":\"([^\"]+)\"/,\n      /\"browser_native_sd_url\":\"([^\"]+)\"/,\n      /sd_src:\"([^\"]+)\"/,\n      /\"video_url\":\"([^\"]+)\"/,\n      /src=\"(https:\\/\\/[^\"]+\\.mp4[^\"]*)\"/,\n      /href=\"(https:\\/\\/video[^\"]+)\"/\n    ]\n\n    for (const pattern of fallbackPatterns) {\n      const match = html.match(pattern)\n      if (match) {\n        let videoUrl = match[1]\n          .replace(/\\\\u0025/g, \"%\")\n          .replace(/\\\\u0026/g, \"&\")\n          .replace(/\\\\u002F/g, \"/\")\n          .replace(/\\\\/g, \"\")\n          .replace(/&amp;/g, \"&\")\n        \n        console.log(\"[FB] Direct fetch found video (HD not available):\", videoUrl.substring(0, 100))\n        \n        const thumbnailMatch = html.match(/\"preferred_thumbnail\":{\"image\":{\"uri\":\"([^\"]+)\"/) ||\n                              html.match(/\"thumbnailImage\":{\"uri\":\"([^\"]+)\"/) ||\n                              html.match(/og:image\"[^>]*content=\"([^\"]+)\"/)\n        \n        const thumbnail = thumbnailMatch ? thumbnailMatch[1].replace(/\\\\/g, \"\").replace(/&amp;/g, \"&\") : undefined\n\n        return {\n          video_url: videoUrl,\n          thumbnail: thumbnail,\n          quality: \"SD\"\n        }\n      }\n    }\n\n    console.log(\"[FB] Direct fetch: No video URL found in response\")\n\n  } catch (e) {\n    console.log(\"[FB] Facebook direct fetch failed:\", e)\n  }\n  return null\n}\n\n// ============================================\n// END FACEBOOK DOWNLOADER\n// ============================================\n\nasync function fetchInstagramData(url: string) {\n  // First try the new Puppeteer backend\n  try {\n    const backendUrl = process.env.BACKEND_URL || 'http://localhost:3001'\n    const response = await fetch(`${backendUrl}/api/reel?url=${encodeURIComponent(url)}`, {\n      headers: {\n        'Accept': 'application/json',\n        'User-Agent': 'Instagram-Downloader-Frontend/1.0'\n      }\n    })\n\n    if (response.ok) {\n      const data = await response.json()\n      if (data.success && data.videoUrl) {\n        return {\n          video_url: data.videoUrl,\n          thumbnail: null, // Will be extracted separately if needed\n          quality: \"HD\",\n          method: `puppeteer-${data.method}`\n        }\n      }\n    }\n  } catch (e) {\n    console.log(\"[v0] Puppeteer backend failed, trying fallback methods:\", e)\n  }\n\n  // Fallback to existing methods\n  const shortcode = extractShortcode(url)\n  if (!shortcode) {\n    throw new Error(\"Invalid Instagram URL\")\n  }\n\n  const approaches = [\n    () => fetchViaInstagramAPI(shortcode),\n    () => fetchViaPageScrape(url),\n    () => fetchViaOEmbed(url)\n  ]\n\n  for (const approach of approaches) {\n    try {\n      const result = await approach()\n      if (result && result.video_url) return result\n    } catch (e) {\n      console.log(\"[v0] Approach failed, trying next:\", e)\n      continue\n    }\n  }\n\n  throw new Error(\"Unable to fetch video. The post may be private or unavailable.\")\n}\n\n// Free Instagram downloader API\nasync function fetchViaRapidAPI(url: string) {\n  try {\n    // Using a free Instagram downloader service\n    const apiUrl = `https://instagram-downloader-download-instagram-videos-stories.p.rapidapi.com/index`\n    \n    const response = await fetch(apiUrl, {\n      method: 'GET',\n      headers: {\n        'X-RapidAPI-Key': process.env.RAPIDAPI_KEY || 'demo-key',\n        'X-RapidAPI-Host': 'instagram-downloader-download-instagram-videos-stories.p.rapidapi.com'\n      }\n    })\n\n    if (!response.ok) return null\n\n    const data = await response.json()\n    \n    if (data.video_url) {\n      return {\n        video_url: data.video_url,\n        thumbnail: data.thumbnail || data.image_url,\n        quality: \"HD\",\n        duration: data.duration\n      }\n    }\n  } catch (e) {\n    console.log(\"RapidAPI approach failed:\", e)\n  }\n  return null\n}\n\n// Alternative free service approach\nasync function fetchViaInstagramAPI(shortcode: string) {\n  try {\n    // Using Instagram's embed endpoint\n    const embedUrl = `https://www.instagram.com/p/${shortcode}/embed/captioned/`\n    \n    const response = await fetch(embedUrl, {\n      headers: {\n        \"User-Agent\": \"Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)\",\n        \"Accept\": \"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\",\n        \"Accept-Language\": \"en-US,en;q=0.9\",\n      },\n    })\n\n    if (!response.ok) return null\n\n    const html = await response.text()\n    \n    // Look for video data in the embed page\n    const videoMatch = html.match(/\"video_url\":\"([^\"]+)\"/) || \n                      html.match(/\"src\":\"([^\"]+\\.mp4[^\"]*)\"/) ||\n                      html.match(/videoUrl['\"]\\s*:\\s*['\"]([^'\"]+)['\"]/);\n    \n    const thumbnailMatch = html.match(/\"display_url\":\"([^\"]+)\"/) || \n                          html.match(/\"thumbnail_url\":\"([^\"]+)\"/) ||\n                          html.match(/thumbnailUrl['\"]\\s*:\\s*['\"]([^'\"]+)['\"]/);\n\n    if (videoMatch) {\n      const videoUrl = videoMatch[1].replace(/\\\\u0026/g, \"&\").replace(/\\\\u002F/g, \"/\").replace(/\\\\/g, \"\")\n      const thumbnail = thumbnailMatch ? thumbnailMatch[1].replace(/\\\\u0026/g, \"&\").replace(/\\\\u002F/g, \"/\").replace(/\\\\/g, \"\") : undefined\n\n      return {\n        video_url: videoUrl,\n        thumbnail: thumbnail,\n        quality: \"HD\"\n      }\n    }\n  } catch (e) {\n    console.log(\"Instagram API approach failed:\", e)\n  }\n  return null\n}\n\nasync function fetchViaOEmbed(url: string) {\n  try {\n    // Method 1: Try Instagram's oEmbed\n    const oembedUrl = `https://api.instagram.com/oembed/?url=${encodeURIComponent(url)}`\n\n    const response = await fetch(oembedUrl, {\n      headers: {\n        \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36\",\n      },\n    })\n\n    if (response.ok) {\n      const data = await response.json()\n      \n      // Try to extract video from oEmbed HTML\n      if (data.html) {\n        const videoMatch = data.html.match(/src=\"([^\"]+\\.mp4[^\"]*)\"/) || \n                          data.html.match(/\"video_url\":\"([^\"]+)\"/)\n        \n        if (videoMatch) {\n          return {\n            video_url: videoMatch[1],\n            thumbnail: data.thumbnail_url,\n            quality: \"HD\"\n          }\n        }\n      }\n\n      // Return at least thumbnail if available\n      if (data.thumbnail_url) {\n        return {\n          thumbnail: data.thumbnail_url\n        }\n      }\n    }\n\n    // Method 2: Try alternative approach with different service\n    return await fetchViaAlternativeService(url)\n    \n  } catch (e) {\n    console.log(\"oEmbed approach failed:\", e)\n    return null\n  }\n}\n\nasync function fetchViaAlternativeService(url: string) {\n  try {\n    // Using a simple approach that mimics browser behavior\n    const shortcode = extractShortcode(url)\n    if (!shortcode) return null\n\n    // Try accessing the post with mobile user agent\n    const mobileUrl = `https://www.instagram.com/p/${shortcode}/`\n    \n    const response = await fetch(mobileUrl, {\n      headers: {\n        \"User-Agent\": \"Instagram 76.0.0.15.395 Android (24/7.0; 640dpi; 1440x2560; samsung; SM-G930F; herolte; samsungexynos8890; en_US; 138226743)\",\n        \"Accept\": \"*/*\",\n        \"Accept-Language\": \"en-US,en;q=0.9\",\n      },\n    })\n\n    if (!response.ok) return null\n\n    const html = await response.text()\n    \n    // Look for video data in mobile version\n    const videoMatch = html.match(/\"video_url\":\"([^\"]+)\"/) ||\n                      html.match(/videoUrl['\"]\\s*:\\s*['\"]([^'\"]+)['\"]/) ||\n                      html.match(/\"src\":\"([^\"]+\\.mp4[^\"]*)\"/)\n\n    if (videoMatch) {\n      const videoUrl = videoMatch[1].replace(/\\\\u0026/g, \"&\").replace(/\\\\u002F/g, \"/\").replace(/\\\\/g, \"\")\n      \n      const thumbnailMatch = html.match(/\"display_url\":\"([^\"]+)\"/) ||\n                            html.match(/\"thumbnail_url\":\"([^\"]+)\"/)\n      \n      const thumbnail = thumbnailMatch ? thumbnailMatch[1].replace(/\\\\u0026/g, \"&\").replace(/\\\\u002F/g, \"/\").replace(/\\\\/g, \"\") : undefined\n\n      return {\n        video_url: videoUrl,\n        thumbnail: thumbnail,\n        quality: \"HD\"\n      }\n    }\n\n  } catch (e) {\n    console.log(\"Alternative service failed:\", e)\n  }\n  return null\n}\n\nasync function fetchViaPageScrape(url: string) {\n  try {\n    // Method 1: Try with different user agents and approaches\n    const userAgents = [\n      \"Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)\",\n      \"Mozilla/5.0 (compatible; facebookexternalhit/1.1; +http://www.facebook.com/externalhit_uatext.php)\",\n      \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n      \"Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/605.1.15\"\n    ]\n\n    for (const userAgent of userAgents) {\n      try {\n        const result = await tryFetchWithUserAgent(url, userAgent)\n        if (result && result.video_url) return result\n      } catch (e) {\n        continue\n      }\n    }\n\n    // Method 2: Try embed approach\n    const shortcode = extractShortcode(url)\n    if (shortcode) {\n      const embedResult = await tryEmbedApproach(shortcode)\n      if (embedResult && embedResult.video_url) return embedResult\n    }\n\n  } catch (e) {\n    console.log(\"Page scrape failed:\", e)\n  }\n  return null\n}\n\nasync function tryFetchWithUserAgent(url: string, userAgent: string) {\n  const response = await fetch(url, {\n    headers: {\n      \"User-Agent\": userAgent,\n      \"Accept\": \"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8\",\n      \"Accept-Language\": \"en-US,en;q=0.9\",\n      \"Cache-Control\": \"no-cache\",\n      \"Pragma\": \"no-cache\"\n    },\n    redirect: \"follow\",\n  })\n\n  if (!response.ok) return null\n\n  const html = await response.text()\n  return extractVideoFromHTML(html)\n}\n\nasync function tryEmbedApproach(shortcode: string) {\n  const embedUrl = `https://www.instagram.com/p/${shortcode}/embed/`\n  \n  const response = await fetch(embedUrl, {\n    headers: {\n      \"User-Agent\": \"Mozilla/5.0 (compatible; facebookexternalhit/1.1)\",\n      \"Accept\": \"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\",\n    },\n  })\n\n  if (!response.ok) return null\n\n  const html = await response.text()\n  return extractVideoFromHTML(html)\n}\n\nasync function fetchViaRegularScrape(url: string) {\n  const response = await fetch(url, {\n    headers: {\n      \"User-Agent\": \"Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Mobile/15E148 Safari/604.1\",\n      \"Accept\": \"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8\",\n      \"Accept-Language\": \"en-US,en;q=0.9\",\n    },\n    redirect: \"follow\",\n  })\n\n  if (!response.ok) return null\n\n  const html = await response.text()\n  return extractVideoFromHTML(html)\n}\n\nfunction extractVideoFromJSON(data: any) {\n  try {\n    // Navigate through possible JSON structures\n    const items = data?.items || data?.graphql?.shortcode_media || data?.data?.shortcode_media\n    \n    if (Array.isArray(items) && items.length > 0) {\n      const item = items[0]\n      const videoVersions = item.video_versions\n      const imageVersions = item.image_versions2?.candidates\n      \n      if (videoVersions && videoVersions.length > 0) {\n        return {\n          video_url: videoVersions[0].url,\n          thumbnail: imageVersions?.[0]?.url || item.display_url,\n          quality: \"HD\",\n          duration: item.video_duration \n            ? `${Math.floor(item.video_duration / 60)}:${String(Math.floor(item.video_duration % 60)).padStart(2, \"0\")}`\n            : undefined,\n        }\n      }\n    } else if (items) {\n      // Single item structure\n      const videoUrl = items.video_url\n      const thumbnail = items.display_url || items.thumbnail_src\n      \n      if (videoUrl) {\n        return {\n          video_url: videoUrl,\n          thumbnail: thumbnail,\n          quality: \"HD\",\n          duration: items.video_duration \n            ? `${Math.floor(items.video_duration / 60)}:${String(Math.floor(items.video_duration % 60)).padStart(2, \"0\")}`\n            : undefined,\n        }\n      }\n    }\n  } catch (e) {\n    console.log(\"Error extracting from JSON:\", e)\n  }\n  return null\n}\n\nfunction extractVideoFromHTML(html: string) {\n  // Clean up HTML entities first\n  const cleanHtml = html.replace(/\\\\u0026/g, \"&\").replace(/\\\\u002F/g, \"/\").replace(/\\\\/g, \"\")\n\n  // Multiple patterns to try for video URLs\n  const videoPatterns = [\n    /\"video_url\":\"([^\"]+)\"/,\n    /\"playback_url\":\"([^\"]+)\"/,\n    /\"src\":\"([^\"]+\\.mp4[^\"]*)\"/,\n    /\"videoUrl\":\"([^\"]+)\"/,\n    /property=\"og:video:secure_url\"[^>]*content=\"([^\"]+)\"/,\n    /property=\"og:video\"[^>]*content=\"([^\"]+)\"/,\n    /meta[^>]*property=\"og:video\"[^>]*content=\"([^\"]+)\"/,\n    /\"video_versions\":\\[{\"url\":\"([^\"]+)\"/,\n    /\"video_dash_manifest\":\"[^\"]*\",\"video_url\":\"([^\"]+)\"/,\n    /videoUrl['\"]\\s*:\\s*['\"]([^'\"]+)['\"]/,\n    /\"contentUrl\":\"([^\"]+\\.mp4[^\"]*)\"/,\n    /src=\"([^\"]+\\.mp4[^\"]*)\"/,\n    /\"url\":\"([^\"]+\\.mp4[^\"]*)\"/\n  ]\n\n  const thumbnailPatterns = [\n    /\"display_url\":\"([^\"]+)\"/,\n    /\"thumbnail_src\":\"([^\"]+)\"/,\n    /\"thumbnail_url\":\"([^\"]+)\"/,\n    /property=\"og:image\"[^>]*content=\"([^\"]+)\"/,\n    /meta[^>]*property=\"og:image\"[^>]*content=\"([^\"]+)\"/,\n    /\"image_versions2\":{\"candidates\":\\[{\"url\":\"([^\"]+)\"/,\n    /thumbnailUrl['\"]\\s*:\\s*['\"]([^'\"]+)['\"]/\n  ]\n\n  let videoUrl = null\n  let thumbnail = null\n\n  // Try to find video URL\n  for (const pattern of videoPatterns) {\n    const match = cleanHtml.match(pattern)\n    if (match && match[1]) {\n      const url = match[1]\n      // Validate it's a proper video URL\n      if (url.includes('.mp4') || url.includes('video') || url.includes('scontent')) {\n        videoUrl = url\n        break\n      }\n    }\n  }\n\n  // Try to find thumbnail\n  for (const pattern of thumbnailPatterns) {\n    const match = cleanHtml.match(pattern)\n    if (match && match[1]) {\n      thumbnail = match[1]\n      break\n    }\n  }\n\n  // If no video found, try to extract from script tags\n  if (!videoUrl) {\n    const scriptMatches = cleanHtml.match(/<script[^>]*>(.*?)<\\/script>/g)\n    if (scriptMatches) {\n      for (const script of scriptMatches) {\n        for (const pattern of videoPatterns) {\n          const match = script.match(pattern)\n          if (match && match[1]) {\n            const url = match[1]\n            if (url.includes('.mp4') || url.includes('video') || url.includes('scontent')) {\n              videoUrl = url\n              break\n            }\n          }\n        }\n        if (videoUrl) break\n      }\n    }\n  }\n\n  if (!videoUrl) return null\n\n  return {\n    video_url: videoUrl,\n    thumbnail: thumbnail,\n    quality: \"HD\",\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    // Get client IP for rate limiting\n    const ip = request.headers.get(\"x-forwarded-for\")?.split(\",\")[0] || request.headers.get(\"x-real-ip\") || \"unknown\"\n\n    // Check rate limit\n    if (!checkRateLimit(ip)) {\n      return NextResponse.json(\n        { success: false, error: \"Too many requests. Please wait a moment and try again.\" },\n        { status: 429 },\n      )\n    }\n\n    const body = await request.json()\n    const { url } = body\n\n    if (!url) {\n      return NextResponse.json({ success: false, error: \"URL is required\" }, { status: 400 })\n    }\n\n    // ============================================\n    // ROUTING LOGIC: FACEBOOK OR INSTAGRAM\n    // ============================================\n    \n    // Check if it's a Facebook URL\n    if (isFacebookURL(url)) {\n      console.log(\"[FB] Detected Facebook URL, using Facebook downloader\")\n      \n      try {\n        const videoData = await fetchFacebookVideo(url)\n\n        if (!videoData || !videoData.video_url) {\n          console.log(\"[FB] No video data returned\")\n          return NextResponse.json(\n            { success: false, error: \"Unable to fetch Facebook video. The post may be private or unavailable.\" },\n            { status: 404 },\n          )\n        }\n\n        console.log(\"[FB] Successfully returning video data\")\n        return NextResponse.json({\n          success: true,\n          ...videoData,\n        })\n      } catch (fbError) {\n        console.error(\"[FB] Facebook download error:\", fbError)\n        return NextResponse.json(\n          { success: false, error: fbError instanceof Error ? fbError.message : \"Facebook video download failed\" },\n          { status: 500 },\n        )\n      }\n    }\n\n    // ============================================\n    // INSTAGRAM LOGIC (UNCHANGED)\n    // ============================================\n\n    // Validate Instagram URL format\n    const validPatterns = [\n      /^https?:\\/\\/(www\\.)?instagram\\.com\\/p\\/[\\w-]+/,\n      /^https?:\\/\\/(www\\.)?instagram\\.com\\/reel\\/[\\w-]+/,\n      /^https?:\\/\\/(www\\.)?instagram\\.com\\/reels\\/[\\w-]+/,\n      /^https?:\\/\\/(www\\.)?instagram\\.com\\/tv\\/[\\w-]+/,\n    ]\n\n    if (!validPatterns.some((p) => p.test(url))) {\n      return NextResponse.json({ success: false, error: \"Invalid Instagram or Facebook URL format\" }, { status: 400 })\n    }\n\n    const videoData = await fetchInstagramData(url)\n\n    if (!videoData || !videoData.video_url) {\n      return NextResponse.json(\n        { success: false, error: \"Unable to fetch video. The post may be private or unavailable.\" },\n        { status: 404 },\n      )\n    }\n\n    return NextResponse.json({\n      success: true,\n      ...videoData,\n    })\n  } catch (error) {\n    console.error(\"[v0] Error processing request:\", error)\n\n    const message = error instanceof Error ? error.message : \"An unexpected error occurred\"\n\n    return NextResponse.json({ success: false, error: message }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}